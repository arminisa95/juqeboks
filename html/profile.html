<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Profile || Juke</title>
    <script>
        if (window.top === window.self) {
            window.location.replace('../index.html#/profile');
        }
    </script>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/profile.css">
    <link rel="stylesheet" href="../css/musicplayer.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="../js/player.js" defer></script>
    <script src="../js/auth.js" defer></script>
</head>
<body class="auth-page">
    <header>
        <a href="../index.html">
            <img src="../images/juqe.png" alt="Juke Logo" class="logo-img">
        </a>
    </header>

    <main class="auth-main">
        <div class="profile-container">
            <h1 class="profile-title">Profile & Settings</h1>

            <div class="profile-subtitle">Signed in as <span class="username-display"></span></div>

            <div id="profileMessage" class="profile-message" style="display:none"></div>

            <form id="profileForm">
                <div class="form-group">
                    <label for="profileEmail">Email</label>
                    <input type="email" id="profileEmail" name="profileEmail" disabled>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="profileFirstName">First Name</label>
                        <input type="text" id="profileFirstName" name="profileFirstName">
                    </div>
                    <div class="form-group">
                        <label for="profileLastName">Last Name</label>
                        <input type="text" id="profileLastName" name="profileLastName">
                    </div>
                </div>

                <div class="form-group">
                    <label for="profileBio">Bio</label>
                    <input type="text" id="profileBio" name="profileBio" placeholder="Tell us something about you">
                </div>

                <div class="form-group">
                    <label for="profileAvatar">Profile Picture</label>
                    <div class="avatar-upload-container">
                        <div class="avatar-preview" id="avatarPreview">
                            <img id="avatarPreviewImg" src="../images/juke.png" alt="Profile Preview" class="avatar-preview-img">
                            <div class="avatar-preview-placeholder">
                                <i class="fas fa-camera"></i>
                                <span>Click to upload</span>
                            </div>
                        </div>
                        <input type="file" id="profileAvatarFile" name="profileAvatarFile" accept="image/*" style="display: none;">
                        <input type="url" id="profileAvatar" name="profileAvatar" placeholder="https://..." style="display: none;">
                        <button type="button" id="avatarUploadBtn" class="profile-btn secondary">Upload Picture</button>
                        <button type="button" id="avatarRemoveBtn" class="profile-btn secondary" style="display: none;">Remove Picture</button>
                    </div>
                </div>

                <button type="submit" class="profile-btn">Save Settings</button>
            </form>

            <button type="button" id="logoutBtn" class="profile-btn secondary">Log out</button>

            <div class="profile-links">
                <a href="user.html">Back to _app</a>
            </div>
        </div>
    </main>

    <footer>
        <p class="contact">All rights reserved &copy; 2025 juqeboks</p>
        <a id="mail" href="mailto:arminisa@outlook.com" class="contact">contact:mail</a>
        <a id="phone" href="tel:06509014453" class="contact">contact:phone</a>

        <a href="../index.html" class="floating-button">
            <img src="../images/U-pink.png" alt="Juke Logo">
        </a>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Avatar upload functionality
            const avatarPreview = document.getElementById('avatarPreview');
            const avatarPreviewImg = document.getElementById('avatarPreviewImg');
            const avatarFileInput = document.getElementById('profileAvatarFile');
            const avatarUrlInput = document.getElementById('profileAvatar');
            const uploadBtn = document.getElementById('avatarUploadBtn');
            const removeBtn = document.getElementById('avatarRemoveBtn');

            // Load current avatar
            loadCurrentAvatar();

            // Click handlers
            avatarPreview.addEventListener('click', () => avatarFileInput.click());
            uploadBtn.addEventListener('click', () => avatarFileInput.click());
            removeBtn.addEventListener('click', removeAvatar);

            // File input change handler
            avatarFileInput.addEventListener('change', handleFileSelect);

            function loadCurrentAvatar() {
                const token = localStorage.getItem('juke_token');
                if (!token) return;

                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const currentAvatar = payload.avatar_url;
                    
                    if (currentAvatar) {
                        avatarPreviewImg.src = currentAvatar;
                        avatarPreview.classList.add('has-image');
                        avatarUrlInput.value = currentAvatar;
                        removeBtn.style.display = 'inline-block';
                        uploadBtn.textContent = 'Change Picture';
                    }
                } catch (error) {
                    console.error('Error loading current avatar:', error);
                }
            }

            function handleFileSelect(e) {
                const file = e.target.files[0];
                if (!file) return;

                // Validate file type
                if (!file.type.startsWith('image/')) {
                    showMessage('Please select an image file.', 'error');
                    return;
                }

                // Validate file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showMessage('Image size must be less than 5MB.', 'error');
                    return;
                }

                // Preview the image
                const reader = new FileReader();
                reader.onload = function(e) {
                    avatarPreviewImg.src = e.target.result;
                    avatarPreview.classList.add('has-image');
                    removeBtn.style.display = 'inline-block';
                    uploadBtn.textContent = 'Change Picture';
                    
                    // Store the file for upload
                    avatarPreview.dataset.newAvatar = 'true';
                };
                reader.readAsDataURL(file);
            }

            function removeAvatar() {
                avatarPreviewImg.src = '../images/juke.png';
                avatarPreview.classList.remove('has-image');
                avatarUrlInput.value = '';
                avatarFileInput.value = '';
                removeBtn.style.display = 'none';
                uploadBtn.textContent = 'Upload Picture';
                delete avatarPreview.dataset.newAvatar;
            }

            function showMessage(message, type) {
                const messageEl = document.getElementById('profileMessage');
                messageEl.textContent = message;
                messageEl.className = `profile-message ${type}`;
                messageEl.style.display = 'block';
                
                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, 5000);
            }

            // Handle form submission with avatar upload
            const profileForm = document.getElementById('profileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(profileForm);
                    const token = localStorage.getItem('juke_token');
                    
                    if (!token) {
                        showMessage('Please log in first.', 'error');
                        return;
                    }

                    // Handle avatar upload if new image selected
                    if (avatarPreview.dataset.newAvatar === 'true' && avatarFileInput.files[0]) {
                        try {
                            const avatarFormData = new FormData();
                            avatarFormData.append('avatar', avatarFileInput.files[0]);
                            
                            const response = await fetch('/api/users/avatar', {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${token}`
                                },
                                body: avatarFormData
                            });
                            
                            if (response.ok) {
                                const result = await response.json();
                                formData.set('profileAvatar', result.avatar_url);
                            } else {
                                throw new Error('Avatar upload failed');
                            }
                        } catch (error) {
                            showMessage('Failed to upload avatar. Please try again.', 'error');
                            return;
                        }
                    }

                    // Update profile data
                    try {
                        const response = await fetch('/api/users/profile', {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                first_name: formData.get('profileFirstName'),
                                last_name: formData.get('profileLastName'),
                                bio: formData.get('profileBio'),
                                avatar_url: formData.get('profileAvatar')
                            })
                        });

                        if (response.ok) {
                            showMessage('Profile updated successfully!', 'success');
                            
                            // Update token with new avatar
                            const result = await response.json();
                            if (result.token) {
                                localStorage.setItem('juke_token', result.token);
                            }
                            
                            // Remove new avatar flag
                            delete avatarPreview.dataset.newAvatar;
                        } else {
                            throw new Error('Profile update failed');
                        }
                    } catch (error) {
                        showMessage('Failed to update profile. Please try again.', 'error');
                    }
                });
            }
        });
    </script>
</body>
</html>
